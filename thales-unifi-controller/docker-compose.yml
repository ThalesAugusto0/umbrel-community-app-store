services:
  app_proxy:
    environment:
      APP_HOST: thales-unifi-controller_https_bridge_1
      APP_PORT: 8000
      PROXY_AUTH_ADD: "false"

  server:
    image: jacobalberty/unifi:latest
    restart: on-failure
    environment:
      - TZ=America/Sao_Paulo
      - UNIFI_UID=1000
      - UNIFI_GID=1000
      - RUNAS_UID0=false
      - BIND_PRIV=false
      - DB_MONGO_URI=mongodb://unifi:unifipwd123@db:27017/unifi
      - DB_MONGO_STAT_URI=mongodb://unifi:unifipwd123@db:27017/unifi_stat
      - DB_NAME=unifi
    volumes:
      - ${APP_DATA_DIR}/data/unifi-data:/unifi
    ports:
      - "3478:3478/udp"
      - "10001:10001/udp"
      - "18080:8080"
      - "6789:6789/tcp"   # Speed test
      - "8080:8080/tcp"   # Device/ controller comm.
      - "8443:8443/tcp"   # Controller GUI/API as seen in a web browser
      - "8880:8880/tcp"   # HTTP portal redirection
      - "8843:8843/tcp"   # HTTPS portal redirection
      - "10001:10001/udp" # AP discovery
    depends_on:
      - db

  db:
    image: mongo:4.4
    volumes:
      - ${APP_DATA_DIR}/data/mongodb:/data/db
      - ${APP_DATA_DIR}/data/init-mongo.sh:/docker-entrypoint-initdb.d/init-mongo.sh:ro
    restart: on-failure

  https_bridge:
    image: debian:stable-slim
    command: >
      bash -c "apt-get update && apt-get install -y socat && 
      socat TCP-LISTEN:8000,fork,reuseaddr OPENSSL:server:8443,verify=0"
    depends_on:
      - server
    restart: on-failure